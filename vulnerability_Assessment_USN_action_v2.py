#!/usr/bin/env python
"""vulnerability_Assessment_USN_action.py: This script will give you the ACTION items (Restart or Reboot or Standard system update) required for the given USN number."""
__author__      = "Vinoth Kumar Selvaraj"

import openpyxl
import os
import sys
import subprocess
import time

print "\n\t\t\t=========IMPORTANT==========\n"
print " Make sure your workstation has network connectivity to reach https://usn.ubuntu.com/ ,as the script will do curl call for each USN number given"
print "\n\t\t\t===========================\n"

excel_document = openpyxl.load_workbook(raw_input("Enter the Excel Document name with full path: "))
print "The below sheets are availble in the excel document \n"
print excel_document.get_sheet_names()
VA = excel_document.get_sheet_by_name(raw_input("Enter the sheet name to load data from: "))
usn_link_column = raw_input("Enter the Column name of USN entries: ")

def sheet_display():
  usn_report = []
  print VA.max_row
  print VA.max_column
  for cellObj in range(1, VA.max_row + 1):
#      print (VA[str(usn_link_column)+str(cellObj)].value)
      usn_report.append(VA[str(usn_link_column)+str(cellObj)].value)
  return usn_report

def create_column(usn_report):
  new_column = VA.max_column + 1
  VA.insert_cols(new_column)
  for i in range(0, VA.max_row):
    cmd = ' curl -s ' + str(usn_report[i]) + ' | grep -oh \"restart \| reboot \| a standard system update will make all the necessary changes\" || echo \"No Action Item found: Please check your network connectivity\" '
    proc = subprocess.Popen([str(cmd)], stdout=subprocess.PIPE, shell=True)
    (out, err) = proc.communicate()
    print usn_report[i], out
    VA.cell(row = i+1, column = new_column).value = out
  timestr = time.strftime("%Y%m%d-%H%M%S")
  excel_document.save("VA_Report_with_USN_Action_"+str(timestr)+".xlsx")
#  excel2 = openpyxl.load_workbook('test.xlsx')
#  active = excel2.get_sheet_by_name('VA')
#  print VA.max_column


if __name__ == '__main__':
  usn_report = sheet_display()
  create_column(usn_report)
